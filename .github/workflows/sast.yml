name: SAST (Snyk Code)

on:
  workflow_dispatch:
    inputs:
      severity-threshold:
        description: "Minimum severity to fail the build"
        required: true
        default: "high"
        type: choice
        options:
          - low
          - medium
          - high
      scan-path:
        description: "Path to scan (narrow for faster runs)"
        required: true
        default: "Controllers"
        type: string
      exclude:
        description: "Comma-separated paths to skip"
        required: true
        default: "wwwroot,Database,bin,obj"
        type: string

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  sast:
    name: SAST
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      SNYK_ORG: ${{ secrets.SNYK_ORG }}
    steps:
      # Checkout the repo so Snyk can scan the source.
      - name: Checkout source
        uses: actions/checkout@v4

      # Ensure the .NET 8 SDK is available for AspGoat restore/build context.
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      # Prepare report paths and a timestamped artifact suffix.
      - name: Prepare reports
        run: |
          mkdir -p reports
          echo "REPORT_TS=$(date -u +%Y%m%d-%H%M%S)" >> "$GITHUB_ENV"

      # Install Snyk CLI and authenticate using the repo secret.
      - name: Snyk auth
        uses: snyk/actions/setup@master

      # Run Snyk Code SAST (targets C# MVC paths like SQLi/XSS).
      - name: Run Snyk Code (SAST)
        id: snyk_code
        continue-on-error: true
        run: |
          ORG_ARG=""
          if [ -n "$SNYK_ORG" ]; then
            ORG_ARG="--org=$SNYK_ORG"
          fi
          snyk code test "${{ inputs.scan-path }}" \
            --sarif-file-output=reports/snyk-code.sarif \
            --severity-threshold=${{ inputs.severity-threshold || 'high' }} \
            --exclude="${{ inputs.exclude }}" \
            --json $ORG_ARG > reports/snyk-code.json

      # Run Snyk Open Source (SCA) to scan dependencies.
      - name: Run Snyk Open Source (SCA)
        id: snyk_oss
        continue-on-error: true
        run: |
          ORG_ARG=""
          if [ -n "$SNYK_ORG" ]; then
            ORG_ARG="--org=$SNYK_ORG"
          fi
          snyk test \
            --all-projects \
            --sarif-file-output=reports/snyk-oss.sarif \
            --severity-threshold=${{ inputs.severity-threshold || 'high' }} \
            --json $ORG_ARG > reports/snyk-oss.json

      # Upload findings to GitHub code scanning.
      - name: Upload SAST SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/snyk-code.sarif
          category: snyk-code-sast

      # Upload SCA findings to GitHub code scanning.
      - name: Upload SCA SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/snyk-oss.sarif
          category: snyk-oss-sca

      # Always retain the reports as artifacts.
      - name: Upload SAST artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sast-${{ env.REPORT_TS }}
          path: |
            reports/snyk-code.sarif
            reports/snyk-code.json
          if-no-files-found: warn

      - name: Upload SCA artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sca-${{ env.REPORT_TS }}
          path: |
            reports/snyk-oss.sarif
            reports/snyk-oss.json
          if-no-files-found: warn

      # Write a brief summary for quick visibility in the run output.
      - name: Job summary
        if: always()
        run: |
          {
            echo "### SAST + SCA (Snyk)"
            echo "- Threshold: ${{ inputs.severity-threshold || 'high' }}"
            echo "- Scan path: ${{ inputs.scan-path }}"
            echo "- Exclude: ${{ inputs.exclude }}"
            echo "- SAST SARIF: reports/snyk-code.sarif"
            echo "- SCA SARIF: reports/snyk-oss.sarif"
            echo "- Artifacts: snyk-sast-${{ env.REPORT_TS }}, snyk-sca-${{ env.REPORT_TS }}"
          } >> "$GITHUB_STEP_SUMMARY"

      # Fail the job if Snyk found issues at/above the threshold.
      - name: Enforce failure on findings
        if: steps.snyk_code.outcome == 'failure' || steps.snyk_oss.outcome == 'failure'
        run: |
          echo "Snyk found issues at or above the threshold."
          exit 1
